<script>
const boardEl = document.getElementById("board");
const statusEl = document.getElementById("status");
const usersEl = document.getElementById("users");
const startBtn = document.getElementById("start");

let board = Array(9).fill(null);
let gameOn = false;
let botLevel = "online";

let ws;
let myId;
let myMark;
let duelId;
let myTurn = false;
let joinedOnline = false;

const wins = [
  [0,1,2],[3,4,5],[6,7,8],
  [0,3,6],[1,4,7],[2,5,8],
  [0,4,8],[2,4,6]
];

function draw() {
  boardEl.innerHTML = "";
  board.forEach((v,i)=>{
    const c = document.createElement("div");
    c.className = "cell";
    c.textContent = v || "";
    c.onclick = () => clickCell(i);
    boardEl.appendChild(c);
  });
}

function startGame() {
  const name = document.getElementById("name").value.trim();
  if (!name) return alert("enter a name");

  botLevel = document.getElementById("mode").value;

  if (botLevel === "online") {
    if (joinedOnline) return;
    connect(name);
    joinedOnline = true;
    startBtn.disabled = true;
  }
}

function clickCell(i) {
  if (!gameOn) return;
  if (!myTurn) return;
  if (board[i]) return;

  ws.send(JSON.stringify({
    type: "move",
    duelId,
    index: i
  }));
}

function end(text) {
  statusEl.textContent = text;
  gameOn = false;
  myTurn = false;
}

function connect(name) {
  const proto = location.protocol === "https:" ? "wss" : "ws";
  ws = new WebSocket(`${proto}://${location.host}`);

  ws.onopen = () => {
    ws.send(JSON.stringify({ type: "setName", name }));
  };

  ws.onmessage = e => {
    const msg = JSON.parse(e.data);

    if (msg.type === "nameTaken") {
      alert("name already taken");
      location.reload();
    }

    if (msg.type === "assignId") myId = msg.userId;

    if (msg.type === "userList") {
      usersEl.innerHTML = "";
      msg.list.forEach(u=>{
        if (u.id !== myId) {
          const d = document.createElement("div");
          d.textContent = u.name;
          d.onclick = () => ws.send(JSON.stringify({
            type: "challenge",
            target: u.id
          }));
          usersEl.appendChild(d);
        }
      });
    }

    if (msg.type === "challengeRequest") {
      if (confirm(`${msg.name} wants to duel`)) {
        ws.send(JSON.stringify({
          type: "challengeResponse",
          from: msg.from,
          accept: true
        }));
      } else {
        ws.send(JSON.stringify({
          type: "challengeResponse",
          from: msg.from,
          accept: false
        }));
      }
    }

    if (msg.type === "challengeDenied") {
      statusEl.textContent = "challenge denied";
    }

    if (msg.type === "duelStart") {
      duelId = msg.duelId;
      myMark = msg.mark;
      board = Array(9).fill(null);
      gameOn = true;
      myTurn = msg.turn === myId;
      draw();
      statusEl.textContent = myTurn ? "your turn" : "enemy turn";
    }

    if (msg.type === "updateBoard") {
      board = msg.board;
      myTurn = msg.turn === myId;
      draw();
      statusEl.textContent = myTurn ? "your turn" : "enemy turn";
    }

    if (msg.type === "gameOver") {
      end(msg.result);
    }
  };
}

startBtn.onclick = startGame;
draw();
</script>
