<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>tic tac toe duel</title>

<style>
html, body {
    margin:0;
    padding:0;
    width:100%;
    height:100%;
    background:#121212;
    color:#fff;
    font-family:Segoe UI, sans-serif;
    overflow:hidden;
}

#background-img {
    position:absolute;
    top:50%;
    left:50%;
    transform:translate(-50%,-50%);
    width:855px;
    height:675px;
    border-radius:12px;
    object-fit:cover;
    box-shadow:0 12px 40px rgba(0,0,0,.5);
}

#ui {
    position:fixed;
    top:20px;
    left:20px;
    background:rgba(0,0,0,.8);
    padding:15px;
    border-radius:12px;
    width:200px;
}

#ui input, #ui select, #ui button {
    width:100%;
    margin-bottom:6px;
    padding:6px;
    border:none;
    border-radius:6px;
    background:#1f1f1f;
    color:#fff;
}

#ui button {
    background:#4caf50;
    font-weight:bold;
    cursor:pointer;
}

#users {
    margin-top:8px;
    background:#222;
    padding:6px;
    border-radius:6px;
    max-height:180px;
    overflow-y:auto;
}

#users div {
    cursor:pointer;
    padding:4px;
}

#users div:hover {
    background:#333;
}

#duel-request {
    display:none;
    background:#333;
    padding:6px;
    border-radius:6px;
    margin-top:6px;
}

#board-container {
    position:absolute;
    top:200px;
    left:200px;
    background:rgba(30,30,30,.65);
    padding:15px;
    border-radius:16px;
    cursor:move;
}

#board {
    display:grid;
    grid-template-columns:repeat(3,50px);
    gap:8px;
}

.cell {
    width:50px;
    height:50px;
    background:#2c2c2c;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:24px;
    border-radius:8px;
    cursor:pointer;
}

.cell:hover { background:#3a3a3a; }

#status {
    margin-top:10px;
    text-align:center;
    color:#ccc;
}
</style>
</head>

<body>

<img id="background-img" src="forehead.png">

<div id="ui">
    <input id="username" placeholder="your name">
    <select id="mode">
        <option value="online">play online</option>
        <option value="easy">bot_easy</option>
        <option value="medium">bot_medium</option>
        <option value="hard">bot_hard</option>
    </select>
    <button onclick="startGame()">start duel</button>
    <div id="users"></div>
    <div id="duel-request"></div>
</div>

<div id="board-container">
    <div id="board"></div>
    <div id="status">waitingâ€¦</div>
</div>

<script>
const boardEl = document.getElementById("board");
const usersEl = document.getElementById("users");
const statusEl = document.getElementById("status");
const duelReq = document.getElementById("duel-request");

let board = Array(9).fill(null);
let gameActive = false;
let myMark = null;
let myTurn = false;
let duelId = null;
let userId = null;
let name = "";

const protocol = location.protocol === "https:" ? "wss://" : "ws://";
const ws = new WebSocket(protocol + location.host);

/* websocket always connects */
ws.onopen = () => console.log("ws connected");

ws.onmessage = e => {
    const msg = JSON.parse(e.data);

    if (msg.type === "assignId") userId = msg.userId;

    if (msg.type === "userList") {
        usersEl.innerHTML = "online:<br>";
        msg.list.forEach(u => {
            if (u.id !== userId)
                usersEl.innerHTML += `<div onclick="challenge(${u.id})">${u.name}</div>`;
        });
    }

    if (msg.type === "challengeRequest") {
        duelReq.style.display = "block";
        duelReq.innerHTML = `${msg.name} wants to duel
        <button onclick="respond(true,${msg.from})">yes</button>
        <button onclick="respond(false,${msg.from})">no</button>`;
    }

    if (msg.type === "duelStart") {
        duelId = msg.duelId;
        myMark = msg.mark;
        myTurn = msg.turn === userId;
        board = Array(9).fill(null);
        gameActive = true;
        render();
        statusEl.textContent = `you are ${myMark}`;
    }

    if (msg.type === "updateBoard") {
        board = msg.board;
        myTurn = msg.turn === userId;
        render();
    }

    if (msg.type === "gameOver") {
        statusEl.textContent = msg.result;
        gameActive = false;
    }
};

function startGame() {
    name = document.getElementById("username").value.trim();
    if (!name) return alert("name first asshole");
    ws.send(JSON.stringify({ type:"setName", name }));
}

function challenge(id) {
    ws.send(JSON.stringify({ type:"challenge", target:id }));
}

function respond(yes, from) {
    duelReq.style.display = "none";
    ws.send(JSON.stringify({ type:"challengeResponse", from, accept:yes }));
}

function render() {
    boardEl.innerHTML = "";
    board.forEach((v,i)=>{
        const d = document.createElement("div");
        d.className="cell";
        d.textContent = v || "";
        d.onclick = ()=>move(i);
        boardEl.appendChild(d);
    });
    statusEl.textContent = myTurn ? "your turn" : "enemy turn";
}

function move(i) {
    if (!gameActive || !myTurn || board[i]) return;
    ws.send(JSON.stringify({
        type:"move",
        duelId,
        index:i
    }));
}
</script>

</body>
</html>
